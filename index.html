<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR.js Video on Marker (Fixed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <!-- A-Frame and AR.js -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <!-- Video Play Handler -->
  <script>
    AFRAME.registerComponent('videohandler', {
      init: function () {
        const marker = this.el;
        const video = document.querySelector("#vid");
        
        // Add null check
        if (!video) {
          console.error("âŒ Video element not found!");
          return;
        }
        
        console.log("ğŸ“¹ Video handler initialized", video);
        
        // Wait for video to be ready
        video.addEventListener('loadeddata', () => {
          console.log("ğŸ“¼ Video data loaded and ready");
        });
        
        video.addEventListener('error', (e) => {
          console.error("âŒ Video loading error:", e, video.error);
        });
        
        marker.addEventListener('markerFound', () => {
          console.log("âœ… Marker found");
          
          // Ensure video is ready before playing
          if (video.readyState >= 2) { // HAVE_CURRENT_DATA or higher
            video.play().then(() => {
              console.log("â–¶ï¸ Video playing");
            }).catch(err => {
              console.warn("âš ï¸ Video play failed:", err);
              // Try to play again after user interaction
              document.addEventListener('click', () => {
                video.play().catch(e => console.warn("Still can't play:", e));
              }, { once: true });
            });
          } else {
            console.warn("âš ï¸ Video not ready, waiting...");
            video.addEventListener('loadeddata', () => {
              video.play().catch(err => console.warn("âš ï¸ Delayed play failed:", err));
            }, { once: true });
          }
        });
        
        marker.addEventListener('markerLost', () => {
          console.log("âŒ Marker lost");
          video.pause();
        });
      }
    });
    
    // Fixed video orientation component with better stability
    AFRAME.registerComponent('fix-video-orientation', {
      init: function () {
        const el = this.el;
        
        // Apply settings with better positioning for stability
        el.setAttribute('rotation', '-90 0 0');       // Lay flat
        el.setAttribute('position', '0 0.01 0');      // Very close to marker surface
        el.setAttribute('scale', '1.2 1 1');          // Slightly larger for better visibility
        el.setAttribute('width', '1.233');            // Match aspect ratio (755:612)
        el.setAttribute('height', '1');
        
        console.log("ğŸ“ Video orientation set with stability improvements");
        
        // Debug the plane setup
        console.log("ğŸ”§ Plane attributes:", {
          rotation: el.getAttribute('rotation'),
          position: el.getAttribute('position'),
          scale: el.getAttribute('scale'),
          width: el.getAttribute('width'),
          height: el.getAttribute('height')
        });
      }
    });
    
    // Add scene initialization debugging
    document.addEventListener('DOMContentLoaded', () => {
      console.log("ğŸš€ DOM Content Loaded");
      
      const video = document.querySelector("#vid");
      if (video) {
        console.log("ğŸ“¹ Video element found:", video.src);
        
        // Check if video source is accessible
        video.addEventListener('loadstart', () => console.log("ğŸ“¼ Video loading started"));
        video.addEventListener('canplay', () => console.log("âœ… Video ready to play"));
        video.addEventListener('error', (e) => {
          console.error("âŒ Video error details:", {
            error: video.error,
            networkState: video.networkState,
            readyState: video.readyState,
            src: video.src
          });
        });
      } else {
        console.error("âŒ Video element not found in DOM");
      }
    });
  </script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      background: transparent;
      font-family: Arial, sans-serif;
    }
    
    /* Ensure AR scene shows camera feed */
    a-scene {
      background: transparent !important;
    }
    
    /* Make sure video canvas is transparent */
    canvas {
      background: transparent !important;
    }
    
    /* Add debug overlay */
    #debug-info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      z-index: 1000;
      border-radius: 4px;
      max-width: 300px;
    }
    
    #debug-info div {
      margin: 2px 0;
    }
  </style>
</head>
<body>
  <!-- Debug information panel -->
  <div id="debug-info">
    <div>ğŸ” AR.js Debug Panel</div>
    <div id="video-status">ğŸ“¹ Video: Loading...</div>
    <div id="marker-status">ğŸ¯ Marker: Searching...</div>
    <div id="camera-status">ğŸ“· Camera: Initializing...</div>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best; sourceWidth: 1280; sourceHeight: 960; displayWidth: 1280; displayHeight: 960;"
    renderer="antialias: true; alpha: true; precision: mediump;"
    background="transparent: true;"
  >
    <!-- Assets -->
    <a-assets>
      <video
        id="vid"
        src="assets/metamorphosis.mp4"
        preload="auto"
        loop
        muted
        playsinline
        webkit-playsinline
        crossorigin="anonymous"
      ></video>
    </a-assets>
    <!-- Marker with improved tracking -->
    <a-marker
      type="pattern"
      url="assets/pattern.patt"
      videohandler
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5"
      raycaster="objects: .raycastable"
      emitevents="true"
    >
      <a-entity
        geometry="primitive: plane"
        material="shader: flat; src: #vid; transparent: true; alphaTest: 0.1; side: double"
        fix-video-orientation
        class="raycastable"
      ></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>
  
  <script>
    // Additional debugging after scene loads
    window.addEventListener('load', () => {
      const videoStatus = document.getElementById('video-status');
      const markerStatus = document.getElementById('marker-status');
      const cameraStatus = document.getElementById('camera-status');
      
      const video = document.querySelector('#vid');
      const marker = document.querySelector('a-marker');
      
      // Update video status
      if (video) {
        video.addEventListener('loadeddata', () => {
          videoStatus.textContent = 'ğŸ“¹ Video: Ready âœ…';
        });
        video.addEventListener('error', () => {
          videoStatus.textContent = 'ğŸ“¹ Video: Error âŒ';
        });
        video.addEventListener('play', () => {
          videoStatus.textContent = 'ğŸ“¹ Video: Playing â–¶ï¸';
        });
        video.addEventListener('pause', () => {
          videoStatus.textContent = 'ğŸ“¹ Video: Paused â¸ï¸';
        });
      }
      
      // Update marker status
      if (marker) {
        marker.addEventListener('markerFound', () => {
          markerStatus.textContent = 'ğŸ¯ Marker: Found âœ…';
        });
        marker.addEventListener('markerLost', () => {
          markerStatus.textContent = 'ğŸ¯ Marker: Lost âŒ';
        });
      }
      
      // Camera status
      setTimeout(() => {
        cameraStatus.textContent = 'ğŸ“· Camera: Active âœ…';
      }, 2000);
      
      console.log("ğŸ¬ All systems initialized");
    });
  </script>
</body>
</html>
